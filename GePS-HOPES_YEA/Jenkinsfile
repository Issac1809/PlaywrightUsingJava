/*  Jenkinsfile â€” GePS-HOPES_YEA  */
pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    options {
        timestamps()
    }

    environment {
        // â”€â”€ Repo / Branch Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        JOB_NAME           = 'GePS-HOPES_YEA'
        DEVELOPMENT_BRANCH = 'GePS-HOPES'
        TESTING_BRANCH     = 'main'
        CREDENTIALS_ID     = '813c6e55-37f7-4f42-8153-3a19b435f10b'

        // â”€â”€ Build / Test Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        MAVEN_GOALS        = 'clean install -DskipTests=true'
        PROJECT_NAME       = 'GePS-HOPES_YEA'
        TEST_SUITE         = "src/test/resources/testrunners/${PROJECT_NAME}_functional-test.xml"
        WORKING_DIR        = 'GePS-Testing/GePS-HOPES_YEA'

        // â”€â”€ Report Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        OUTPUT_REPORT_DIR     = "${WORKING_DIR}/test-output"
        CHAIN_TEST_REPORT_DIR = "${WORKING_DIR}/test-output"

        // â”€â”€ Miscellaneous â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        WAIT_TIME_SEC = '20'
    }

    stages {

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Clean Workspace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Clean Workspace') {
            steps {
                cleanWs()
                echo 'âœ… Workspace cleaned.'
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Parallel Checkout of Repositories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Checkout Repositories') {
            parallel {
                stage('Checkout GePS') {
                    steps {
                        timeout(time: 10, unit: 'MINUTES') {
                            retry(2) {
                                echo "ğŸ” Checking out GePS repo..."
                                checkout([
                                    $class: 'GitSCM',
                                    branches: [[name: "${DEVELOPMENT_BRANCH}"]],
                                    extensions: [
                                        [$class: 'SparseCheckoutPaths',
                                         sparseCheckoutPaths: [[path: 'GePS - YEA/']]],
                                        [$class: 'CloneOption',
                                         shallow: true, depth: 1, noTags: true, timeout: 10]
                                    ],
                                    userRemoteConfigs: [[
                                        url: 'https://github.com/CormSquare/GePS.git',
                                        credentialsId: "${CREDENTIALS_ID}"
                                    ]]
                                ])
                                echo "âœ… GePS repo checkout complete."
                            }
                        }
                    }
                }

                stage('Checkout GePS-Testing') {
                    steps {
                        timeout(time: 10, unit: 'MINUTES') {
                            retry(2) {
                                dir('GePS-Testing') {
                                    echo "ğŸ” Checking out GePS-Testing repo..."
                                    checkout([
                                        $class: 'GitSCM',
                                        branches: [[name: "${TESTING_BRANCH}"]],
                                        extensions: [
                                            [$class: 'SparseCheckoutPaths',
                                             sparseCheckoutPaths: [[path: 'GePS-HOPES_YEA/']]],
                                            [$class: 'CloneOption',
                                             shallow: true, depth: 1, noTags: true, timeout: 10]
                                        ],
                                        userRemoteConfigs: [[
                                            url: 'https://github.com/CormSquare/GePS-Testing.git',
                                            credentialsId: "${CREDENTIALS_ID}"
                                        ]]
                                    ])
                                }
                                echo "âœ… GePS-Testing repo checkout complete."
                            }
                        }
                    }
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build with Maven (no tests) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Build YEA Project') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "âš™ï¸ Building project (skipping tests)..."
                    bat "mvn ${MAVEN_GOALS}"
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: "${WORKING_DIR}/target/*.jar", onlyIfSuccessful: true
                }
                failure {
                    echo "âŒ Build failed."
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Start Docker Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Start Services') {
            steps {
                dir("${WORKING_DIR}") {
                    script {
                        echo "ğŸ” Verifying Docker daemon..."
                        if (bat(script: 'docker info >nul 2>&1', returnStatus: true) != 0) {
                            error('âŒ Docker is not running or accessible.')
                        }

                        echo "ğŸš€ Starting ChainTest service..."
                        def chainTestRunning = bat(
                            script: "docker compose -f docker-compose-h2.yml ps -q chaintest",
                            returnStdout: true
                        ).trim()
                        if (!chainTestRunning) {
                            bat "docker compose -f docker-compose-h2.yml up -d --remove-orphans"
                        } else {
                            echo "âœ… ChainTest already running."
                        }

                        echo "â³ Waiting ${WAIT_TIME_SEC}s for ChainTest..."
                        bat "timeout /t ${WAIT_TIME_SEC} > nul"

                        echo "ğŸš€ Starting Selenium Grid service..."
                        def seleniumRunning = bat(
                            script: "docker compose -f docker-compose.yaml ps -q selenium-hub",
                            returnStdout: true
                        ).trim()
                        if (!seleniumRunning) {
                            bat "docker compose -f docker-compose.yaml up -d --remove-orphans"
                        } else {
                            echo "âœ… Selenium Grid already running."
                        }

                        echo "â³ Waiting ${WAIT_TIME_SEC}s for Selenium Grid..."
                        bat "timeout /t ${WAIT_TIME_SEC} > nul"
                    }
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Run Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Regression Automation Test') {
            steps {
                dir("${WORKING_DIR}") {
                    timeout(time: 30, unit: 'MINUTES') {
                        echo "ğŸ§ª Executing Playwright test suite..."
                        bat """
                            mvn test ^
                                -Dsurefire.suiteXmlFiles=${TEST_SUITE} ^
                                -DSELENIUM_REMOTE_URL=http://localhost:4444/wd/hub
                        """
                    }
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
                failure {
                    echo "âŒ Test execution failed."
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Publish HTML Reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Publish Reports') {
            steps {
                script {
                    if (fileExists("${CHAIN_TEST_REPORT_DIR}/index.html")) {
                        publishHTML([
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            reportDir: "${CHAIN_TEST_REPORT_DIR}",
                            reportFiles: 'index.html',
                            reportName: 'Chain Test Report'
                        ])
                    } else {
                        echo "âš ï¸ Chain Test Report not found."
                    }

                    if (fileExists("${OUTPUT_REPORT_DIR}/emailable-report.html")) {
                        publishHTML([
                            keepAll: true,
                            alwaysLinkToLastBuild: true,
                            reportDir: "${OUTPUT_REPORT_DIR}",
                            reportFiles: 'emailable-report.html',
                            reportName: 'HTML Extent Report'
                        ])
                    } else {
                        echo "âš ï¸ Test Execution Report not found."
                    }
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Stop Docker Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Stop Services') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "ğŸ›‘ Stopping services..."
                    bat 'docker compose -f docker-compose-h2.yml down --remove-orphans'
                    bat 'docker compose -f docker-compose.yaml down --remove-orphans'
                }
            }
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Notifications & Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    post {
        failure {
            emailext(
                to: 'issac.raja@cormsquare.com',
                subject: "âŒ Build Failed: ${env.JOB_NAME}",
                body: """Hi Team,<br><br>
                         The Jenkins build for <b>${env.JOB_NAME}</b> has <font color="red">FAILED</font>.<br>
                         Please check the attached test reports.<br><br>
                         <a href="${env.BUILD_URL}">Click here to view Jenkins Job</a>""",
                attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}\\index.html, ${OUTPUT_REPORT_DIR}\\emailable-report.html"
            )
        }

        success {
            emailext(
                to: 'issac.raja@cormsquare.com',
                subject: "âœ”ï¸ Build Success: ${env.JOB_NAME}",
                body: """Hi Team,<br><br>
                         The Jenkins build for <b>${env.JOB_NAME}</b> was <font color="green">SUCCESSFUL</font>.<br>
                         Please find the attached test reports.<br><br>
                         <a href="${env.BUILD_URL}">Click here to view Jenkins Job</a>""",
                attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}\\index.html, ${OUTPUT_REPORT_DIR}\\emailable-report.html"
            )
        }

        cleanup {
            cleanWs()
        }
    }
}