pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    options {
        timestamps()
    }

    environment {
        JOB_NAME = 'GePS-HOPES_YEA'
        DEVELOPMENT_BRANCH = 'GePS-HOPES'
        TESTING_BRANCH = "main"
        CREDENTIALS_ID = '813c6e55-37f7-4f42-8153-3a19b435f10b'
        MAVEN_GOALS = 'clean install -DskipTests=true'
        PROJECT_NAME = 'GePS-HOPES_YEA'
        TEST_SUITE = "src/test/resources/testrunners/${PROJECT_NAME}_functional-test.xml"
        WORKING_DIR = 'GePS-Testing/GePS-HOPES_YEA'
        OUTPUT_REPORT_DIR = "${WORKING_DIR}/test-output"
        CHAIN_TEST_REPORT_DIR = "${WORKING_DIR}/test-output"
        SELENIUM_STARTED = 'false'
        CHAINTEST_STARTED = 'false'
    }

    stages {
        stage('Prepare Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Development Repository (GePS)') {
            steps {
                timeout(time: 15, unit: 'MINUTES') {
                    retry(2) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "${DEVELOPMENT_BRANCH}"]],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [
                                [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS - YEA/']]],
                                [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 15]
                            ],
                            userRemoteConfigs: [[
                                url: 'https://github.com/CormSquare/GePS.git',
                                credentialsId: "${CREDENTIALS_ID}"
                            ]]
                        ])
                    }
                }
                echo "‚úÖ Checked out GePS repo directory (GePS - YEA)."
            }
        }

        stage('Checkout Testing Repository (GePS-Testing)') {
            steps {
                timeout(time: 15, unit: 'MINUTES') {
                    retry(2) {
                        dir('GePS-Testing') {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "${TESTING_BRANCH}"]],
                                doGenerateSubmoduleConfigurations: false,
                                extensions: [
                                    [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS-HOPES_YEA/']]],
                                    [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 15]
                                ],
                                userRemoteConfigs: [[
                                    url: 'https://github.com/CormSquare/GePS-Testing.git',
                                    credentialsId: "${CREDENTIALS_ID}"
                                ]]
                            ])
                        }
                    }
                }
                echo "‚úÖ Checked out GePS-Testing repo directory (GePS-HOPES_YEA)."
            }
        }

        stage('Build YEA Project') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "‚öôÔ∏è Building YEA Project (Skipping Tests Only for Build)..."
                    bat "mvn ${MAVEN_GOALS}"
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: "${WORKING_DIR}/target/*.jar", onlyIfSuccessful: true
                }
                failure {
                    echo "‚ùå Build failed. Please check the logs."
                }
            }
        }

        stage('Start Services') {
            parallel {
                stage('Start Main Docker Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üîé Checking for existing Main Docker container..."
                                bat(script: "docker-compose -f docker-compose.yml ps -q main > main_id.txt", returnStatus: true)
                                def mainId = readFile('main_id.txt').trim()
                                if (mainId) {
                                    bat(script: "docker inspect -f \"{{.State.Running}}\" ${mainId} > main_status.txt", returnStatus: true)
                                    if (readFile('main_status.txt').trim() == 'true') {
                                        echo "‚úÖ Main Docker is already running."
                                    } else {
                                        echo "üîÑ Starting Main Docker..."
                                        bat "docker-compose -f docker-compose.yml up -d"
                                    }
                                } else {
                                    echo "üöÄ Starting Main Docker..."
                                    bat "docker-compose -f docker-compose.yml up -d"
                                }
                            }
                        }
                    }
                }

                stage('Start Playwright Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üîé Checking for existing Playwright container..."
                                bat(script: "docker-compose -f docker-compose.playwright.yml ps -q playwright > playwright_id.txt", returnStatus: true)
                                def pid = readFile('playwright_id.txt').trim()
                                if (pid) {
                                    bat(script: "docker inspect -f \"{{.State.Running}}\" ${pid} > playwright_status.txt", returnStatus: true)
                                    if (readFile('playwright_status.txt').trim() == 'true') {
                                        echo "‚úÖ Playwright container is already running."
                                    } else {
                                        echo "üîÑ Starting Playwright..."
                                        bat "docker-compose -f docker-compose.playwright.yml up -d"
                                    }
                                } else {
                                    echo "üöÄ Starting Playwright..."
                                    bat "docker-compose -f docker-compose.playwright.yml up -d"
                                }
                            }
                        }
                    }
                }

                stage('Start ChainTest Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üîé Checking for existing ChainTest container..."
                                bat(script: "docker-compose -f docker-compose-h2.yml ps -q chaintest > chaintest_id.txt", returnStatus: true)
                                def cid = readFile('chaintest_id.txt').trim()
                                if (cid) {
                                    bat(script: "docker inspect -f \"{{.State.Running}}\" ${cid} > chaintest_status.txt", returnStatus: true)
                                    if (readFile('chaintest_status.txt').trim() == 'true') {
                                        echo "‚úÖ ChainTest container is already running."
                                    } else {
                                        echo "üîÑ Starting ChainTest..."
                                        bat "docker-compose -f docker-compose-h2.yml up -d"
                                    }
                                } else {
                                    echo "üöÄ Starting ChainTest..."
                                    bat "docker-compose -f docker-compose-h2.yml up -d"
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Regression Automation Test') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üß™ Running Playwright tests..."
                    bat "docker-compose -f docker-compose.playwright.yml run --rm playwright mvn test -Dsurefire.suiteXmlFiles=${TEST_SUITE}"
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
                failure {
                    echo "‚ùå Test run failed."
                }
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    if (fileExists("${CHAIN_TEST_REPORT_DIR}/index.html")) {
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: "${CHAIN_TEST_REPORT_DIR}",
                            reportFiles: 'index.html',
                            reportName: 'Chain Test Report'
                        ])
                    } else {
                        echo "‚ö†Ô∏è Chain Test report not found."
                    }

                    if (fileExists("${OUTPUT_REPORT_DIR}/emailable-report.html")) {
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: "${OUTPUT_REPORT_DIR}",
                            reportFiles: 'emailable-report.html',
                            reportName: 'HTML Extent Report'
                        ])
                    } else {
                        echo "‚ö†Ô∏è Test execution report not found."
                    }
                }
            }
        }

        stage('Stop Services') {
            parallel {
                stage('Stop Main Docker Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üõë Stopping Main Docker Service..."
                                bat 'docker-compose -f docker-compose.yml down --remove-orphans'
                            }
                        }
                    }
                }

                stage('Stop Playwright Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üõë Stopping Playwright Service..."
                                bat 'docker-compose -f docker-compose.playwright.yml down --remove-orphans'
                            }
                        }
                    }
                }

                stage('Stop ChainTest Service') {
                    steps {
                        dir("${WORKING_DIR}") {
                            script {
                                echo "üõë Stopping ChainTest Service..."
                                bat 'docker-compose -f docker-compose-h2.yml down --remove-orphans'
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            script {
                emailext(
                    to: 'issac.raja@cormsquare.com',
                    subject: "‚ùå Build Failed: ${env.JOB_NAME}",
                    body: """Hi Team,<br><br>
                             The Jenkins build for <b>${env.JOB_NAME}</b> has <font color="red">FAILED</font>.<br>
                             Please check the attached test reports.<br><br>
                             <a href="${env.BUILD_URL}">Click here to view Jenkins Job</a>""",
                    attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}/index.html, ${OUTPUT_REPORT_DIR}/emailable-report.html"
                )
            }
        }
        success {
            script {
                emailext(
                    to: 'issac.raja@cormsquare.com',
                    subject: "‚úîÔ∏è Build Success: ${env.JOB_NAME}",
                    body: """Hi Team,<br><br>
                             The Jenkins build for <b>${env.JOB_NAME}</b> was <font color="green">SUCCESSFUL</font>.<br>
                             Please find the attached test reports for your review.<br><br>
                             <a href="${env.BUILD_URL}">Click here to view Jenkins Job</a>""",
                    attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}/index.html, ${OUTPUT_REPORT_DIR}/emailable-report.html"
                )
            }
        }
        cleanup {
            cleanWs()
        }
    }
}