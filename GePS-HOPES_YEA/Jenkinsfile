pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    environment {
        JOB_NAME = 'GePS-HOPES_YEA'
        DEVELOPMENT_BRANCH = 'GePS-HOPES'
        TESTING_BRANCH = "main"
        CREDENTIALS_ID = '813c6e55-37f7-4f42-8153-3a19b435f10b'
        MAVEN_GOALS = 'clean install -DskipTests=true'
        PROJECT_NAME = 'GePS-HOPES_YEA'
        TEST_SUITE = "src/test/resources/testrunners/${PROJECT_NAME}_functional-test.xml"
        WORKING_DIR = 'GePS-Testing/GePS-HOPES_YEA'
        SUREFIRE_REPORT_DIR = "${WORKING_DIR}/test-output"
        CHAIN_TEST_REPORT_DIR = "${WORKING_DIR}/test-output"
    }

    stages {
        stage('Prepare Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Development Repository (GePS)') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "${DEVELOPMENT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS - YEA/']]],
                        [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 5]
                    ],
                    userRemoteConfigs: [[url: 'https://github.com/CormSquare/GePS.git', credentialsId: "${CREDENTIALS_ID}"]]
                ])
                echo "‚úÖ Checked out GePS repo directory (GePS - YEA)."
            }
        }

        stage('Checkout Testing Repository (GePS-Testing)') {
            steps {
                dir('GePS-Testing') {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "${TESTING_BRANCH}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [
                            [$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'GePS-HOPES_YEA/']]],
                            [$class: 'CloneOption', shallow: true, depth: 1, noTags: true, timeout: 5]
                        ],
                        userRemoteConfigs: [[url: 'https://github.com/CormSquare/GePS-Testing.git', credentialsId: "${CREDENTIALS_ID}"]]
                    ])
                }
                echo "‚úÖ Checked out GePS-Testing repo directory (GePS-HOPES_YEA)."
            }
        }

        stage('Build YEA Project') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "‚öôÔ∏è Building YEA Project (Skipping Tests Only for Build)..."
                    bat "mvn ${MAVEN_GOALS}"
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: "${WORKING_DIR}/target/*.jar", onlyIfSuccessful: true
                }
                failure {
                    echo "‚ùå Build failed. Please check the logs."
                }
            }
        }

        stage('Start Selenium Grid') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üöÄ Starting Selenium Grid using Docker Compose..."
                    script {
                        def result = bat(script: 'docker ps -a -f name=selenium-grid --format "{{.Names}}"', returnStdout: true).trim()
                        if (result == '') {
                            echo "üîÑ Selenium Grid is not running, starting it now..."
                            bat 'docker-compose -f docker-compose.yaml up -d'
                            env.STARTED_DOCKER = "true"
                        } else {
                            echo "üü¢ Selenium Grid is already running."
                        }
                    }
                }
                sleep 10
            }
        }

        stage('Start ChainTest Report Service') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üìù Starting ChainTest reporting service..."
                    script {
                        def result = bat(script: 'docker ps -a -f name=chain-test-service --format "{{.Names}}"', returnStdout: true).trim()
                        if (result == '') {
                            echo "üîÑ ChainTest reporting service not running, starting it now..."
                            bat 'docker-compose -f docker-compose-h2.yml up -d'
                            env.STARTED_DOCKER = "true"
                        } else {
                            echo "üü¢ ChainTest reporting service is already running."
                        }
                    }
                }
                sleep 10
            }
        }

        stage('Regression Automation Test') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üß™ Executing Regression Tests on Latest Build..."
                    bat "mvn test -Dsurefire.suiteXmlFiles=${TEST_SUITE}"
                }
            }
            post {
                always {
                    junit "**/${SUREFIRE_REPORT_DIR}/*.xml"
                }
                failure {
                    echo "‚ùå Tests failed. Please check the test reports."
                }
            }
        }

        stage('Publish Chain Test Report') {
            steps {
                script {
                    if (fileExists("${CHAIN_TEST_REPORT_DIR}/index.html")) {
                        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true,
                                     reportDir: "${CHAIN_TEST_REPORT_DIR}",
                                     reportFiles: 'index.html',
                                     reportName: 'Chain Test Report'])
                    } else {
                        echo "‚ö†Ô∏è Chain test report not found. Skipping report publishing."
                    }
                }
            }
        }

        stage('Publish Test Execution Report') {
            steps {
                script {
                    if (fileExists("${SUREFIRE_REPORT_DIR}/TestExecutionReport.html")) {
                        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true,
                                     reportDir: "${SUREFIRE_REPORT_DIR}",
                                     reportFiles: 'emailable-report.html',
                                     reportName: 'HTML Extent Report'])
                    } else {
                        echo "‚ö†Ô∏è Test execution report not found. Skipping report publishing."
                    }
                }
            }
        }

        stage('Stop Selenium Grid') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üõë Stopping Selenium Grid..."
                    script {
                        if (env.STARTED_DOCKER == 'true') {
                            bat 'docker-compose -f docker-compose.yaml down'
                        }
                    }
                }
            }
        }

        stage('Stop ChainTest Report Service') {
            steps {
                dir("${WORKING_DIR}") {
                    echo "üõë Stopping ChainTest Report Service..."
                    script {
                        if (env.STARTED_DOCKER == 'true') {
                            bat 'docker-compose -f docker-compose-h2.yml down'
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        failure {
            script {
                emailext(
                    to: 'issac.raja@cormsquare.com',
                    subject: "‚ùå Build Failed: ${env.JOB_NAME}",
                    body: """Hi Team,<br><br>
                             The Jenkins build for <b>${env.JOB_NAME}</b> has <font color=\"red\">FAILED</font>.<br>
                             Please check the attached test reports for more details.<br><br>
                             <a href=\"${env.BUILD_URL}\">Click here to view Jenkins Job</a>""",
                    attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}/index.html, ${SUREFIRE_REPORT_DIR}/TestExecutionReport.html"
                )
            }
        }
        success {
            script {
                emailext(
                    to: 'issac.raja@cormsquare.com',
                    subject: "‚úîÔ∏è Build Success: ${env.JOB_NAME}",
                    body: """Hi Team,<br><br>
                             The Jenkins build for <b>${env.JOB_NAME}</b> was <font color=\"green\">SUCCESSFUL</font>.<br>
                             Please find the attached test reports for your review.<br><br>
                             <a href=\"${env.BUILD_URL}\">Click here to view Jenkins Job</a>""",
                    attachmentsPattern: "${CHAIN_TEST_REPORT_DIR}/index.html, ${SUREFIRE_REPORT_DIR}/TestExecutionReport.html"
                )
            }
        }
    }
}
